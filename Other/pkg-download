#!/usr/bin/env python3
# SPDX-License-Identifier: BSD-3-Clause
# Copyright <2025> <Uri Herrera <uri_herrera@nxos.org>>

import subprocess
import os
import sys
from tqdm import tqdm
import shutil

def download_packages(package_list_file, download_dir):
    if not os.path.exists(package_list_file):
        print(f"Error: Package list file '{package_list_file}' not found.")
        sys.exit(1)

    if not os.path.exists(download_dir):
        print(f"Error: Download directory '{download_dir}' not found.")
        sys.exit(1)

    subprocess.run(['sudo', 'apt', 'update'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

    with open(package_list_file, 'r') as f:
        packages = [line.strip() for line in f.readlines()]

    num_packages = len(packages)
    terminal_width = shutil.get_terminal_size().columns
    with tqdm(total=num_packages, desc='Downloading packages', unit='pkg', ncols=terminal_width, bar_format='{desc}: {percentage:3.0f}%|{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}]') as pbar:
        for package in packages:
            os.chdir(download_dir)
            result = subprocess.run(['sudo', 'apt', 'download', package], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            if result.returncode != 0:
                print(f"Package '{package}' not found. Exiting.")
                sys.exit(1)
            pbar.update(1)

    print("\nPackages downloaded successfully.")

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="Download packages from a list using 'apt download'.")
    parser.add_argument('-f', '--file', required=True, help="Path to the package list file.")
    parser.add_argument('-d', '--directory', required=True, help="Directory to download packages to.")
    args = parser.parse_args()

    download_packages(args.file, args.directory)
