#!/usr/bin/env python3
# SPDX-License-Identifier: BSD-3-Clause
# Copyright <2025> <Uri Herrera <uri_herrera@nxos.org>>

import argparse
import os
import shutil
import subprocess
import sys
from subprocess import CalledProcessError

from tqdm import tqdm


def download_packages(package_list_file, download_dir):
    """Download packages listed in a text file using `apt download`.

    The function validates the existence of both the list file and the
    destination directory, performs `apt update`, and then downloads each
    package listed in the file into the given directory. A progress bar is
    displayed during the download process.

    Args:
        package_list_file: Path to a text file containing one package name
            per line.
        download_dir: Path to the directory where package files will be saved.

    Raises:
        SystemExit: If the input file or directory does not exist, if
            `apt update` fails, or if any requested package cannot be
            downloaded.
    """
    if not os.path.exists(package_list_file):
        print(f"Error: Package list file '{package_list_file}' not found.")
        sys.exit(1)

    if not os.path.exists(download_dir):
        print(f"Error: Download directory '{download_dir}' not found.")
        sys.exit(1)

    try:
        subprocess.run(
            ['sudo', 'apt', 'update'],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=True,
        )
    except CalledProcessError:
        print("Failed to update package lists.")
        sys.exit(1)

    with open(package_list_file, 'r', encoding='utf-8') as f:
        packages = [line.strip() for line in f if line.strip()]

    terminal_width = shutil.get_terminal_size().columns

    with tqdm(
        total=len(packages),
        desc='Downloading packages',
        unit='pkg',
        ncols=terminal_width,
        bar_format='{desc}: {percentage:3.0f}%|{bar}| '
                   '{n_fmt}/{total_fmt} [{elapsed}<{remaining}]',
    ) as pbar:
        for package in packages:
            try:
                subprocess.run(
                    ['sudo', 'apt', 'download', package],
                    cwd=download_dir,
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL,
                    check=True,
                )
            except CalledProcessError:
                print(f"Package '{package}' not found. Exiting.")
                sys.exit(1)

            pbar.update(1)

    print("\nPackages downloaded successfully.")


def main():
    """Parse command-line arguments and execute the download workflow.

    This function handles CLI argument parsing for the package list file
    and download directory, then delegates to `download_packages`.
    """
    parser = argparse.ArgumentParser(
        description="Download packages from a list using 'apt download'."
    )
    parser.add_argument(
        '-f', '--file', required=True, help="Path to the package list file."
    )
    parser.add_argument(
        '-d', '--directory', required=True,
        help="Directory to download packages to."
    )
    args = parser.parse_args()

    download_packages(args.file, args.directory)


if __name__ == "__main__":
    main()
