#!/usr/bin/env python3
# SPDX-License-Identifier: BSD-3-Clause
# Copyright <2025> <Uri Herrera <uri_herrera@nxos.org>>

import argparse
import hashlib
import os
import shutil
import subprocess
import sys
import time

from tqdm import tqdm


def is_bootable_iso(iso_file):
    """Determine whether the given ISO file is considered bootable.

    Args:
        iso_file: Path to the ISO image file.

    Returns:
        True if the ISO is treated as bootable, False otherwise.
    """
    return True


def get_file_checksum(file_path):
    """Compute the SHA-256 checksum of a file.

    Args:
        file_path: Path to the file to checksum.

    Returns:
        Hex-encoded SHA-256 checksum string.
    """
    with open(file_path, "rb") as f:
        checksum = hashlib.sha256()
        while True:
            chunk = f.read(4096)
            if not chunk:
                break
            checksum.update(chunk)
    return checksum.hexdigest()


def copy_iso_to_directory(iso_file, target_dir):
    """Copy an ISO file to a directory with progress and checksum verification.

    The function computes the source checksum, copies the file in blocks while
    showing a progress bar, then computes the destination checksum and compares
    it to the source.

    Args:
        iso_file: Path to the ISO file.
        target_dir: Directory where the ISO file will be copied.
    """
    file_size = os.path.getsize(iso_file)
    source_checksum = get_file_checksum(iso_file)

    print(f"Source file: {iso_file}")
    print(f"Target directory: {target_dir}")
    print(f"File size: {file_size} bytes")
    print(f"Source file checksum (SHA-256): {source_checksum}")

    dst_path = os.path.join(target_dir, os.path.basename(iso_file))

    if os.path.exists(dst_path):
        target_checksum = get_file_checksum(dst_path)
        print(f"Target file checksum (SHA-256): {target_checksum}")

        if source_checksum == target_checksum:
            print(
                "File already exists at the target directory with the same "
                "checksum. Skipping copy operation."
            )
            return
        print(
            "File exists at the target directory but with a different "
            "checksum. Deleting it."
        )

        try:
            os.remove(dst_path)
        except OSError as e:
            print(f"Error deleting file: {e}")
            return

    block_size = 4 * 1024 * 1024
    total_blocks = (file_size + block_size - 1) // block_size

    with open(iso_file, "rb") as src_file:
        with open(dst_path, "wb") as dst_file:
            with tqdm(
                total=file_size,
                unit="B",
                unit_scale=True,
                desc="Copying ISO file",
            ) as progress:
                for _ in range(total_blocks):
                    block = src_file.read(block_size)
                    if not block:
                        break
                    dst_file.write(block)
                    dst_file.flush()
                    os.fsync(dst_file.fileno())
                    progress.update(len(block))
                    os.fsync(dst_file.fileno())

    target_checksum = get_file_checksum(dst_path)
    print(f"Target file checksum (SHA-256): {target_checksum}")

    if source_checksum == target_checksum:
        print("Checksums match. File copied successfully.")
    else:
        print("Checksums do not match. File may not have been copied successfully.")


def main():
    """Parse CLI arguments and perform ISO-to-directory copy."""
    parser = argparse.ArgumentParser(
        description="Copy a bootable ISO file to a directory.",
    )
    parser.add_argument(
        "-f",
        "--file",
        help="Path to the bootable ISO file",
        required=True,
    )
    parser.add_argument(
        "-d",
        "--directory",
        help="Target directory",
        required=True,
    )
    args = parser.parse_args()

    if not os.path.isfile(args.file):
        print("Error: Specified file does not exist.")
        return
    if not is_bootable_iso(args.file):
        print("Error: Specified file is not recognized as a bootable ISO.")
        return
    if not os.path.isdir(args.directory):
        print("Error: Specified directory does not exist.")
        return

    copy_iso_to_directory(args.file, args.directory)


if __name__ == "__main__":
    if len(sys.argv) == 1:
        sys.argv.append("-h")
    main()
