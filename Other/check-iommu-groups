#!/usr/bin/env bash

#############################################################################################################################################################################
#   The license used for this file and its contents is: BSD-3-Clause                                                                                                        #
#                                                                                                                                                                           #
#   Copyright <2023> <Uri Herrera <uri_herrera@nxos.org>>                                                                                                                   #
#                                                                                                                                                                           #
#   Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:                          #
#                                                                                                                                                                           #
#    1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.                                        #
#                                                                                                                                                                           #
#    2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer                                      #
#       in the documentation and/or other materials provided with the distribution.                                                                                         #
#                                                                                                                                                                           #
#    3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software                    #
#       without specific prior written permission.                                                                                                                          #
#                                                                                                                                                                           #
#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,                      #
#    THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS                  #
#    BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE                 #
#    GOODS OR SERVICES; LOSS OF USE, DATA,   OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,                      #
#    STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.   #
#############################################################################################################################################################################


# -- Exit on errors.

set -eu


# -- Check IOMMU groups and display output.

find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | while read -r group_path; do
    group_num=$(basename "$group_path")
    lastgroup=""

    devices=("$group_path"/devices/*)
    total_devices=${#devices[@]}
    count=0

    printf "\nGroup %s:\n" "$group_num"

    for d in "${devices[@]}"; do
        device_id=$(basename "$d")
        count=$((count + 1))

        device_info=$(lspci -nms "$device_id" | awk -F"\"" '{printf "[%s:%s]", $4, $6}')
        reset_info=""
        if [[ -e "$d"/reset ]]; then
            reset_info=" [R] "
        else
            reset_info="     "
        fi
        lspci_info=$(lspci -mms "$device_id" | awk -F"\"" '{printf "%s %-40s %s", $1, $2, $6}')

        if [ "$count" -eq "$total_devices" ]; then
            printf "└── %s%s%s\n" "$device_info" "$reset_info" "$lspci_info"
            prefix="    "
        else
            printf "├── %s%s%s\n" "$device_info" "$reset_info" "$lspci_info"
            prefix="│   "
        fi

        usb_devices=("$d"/usb*/)
        usb_count=0
        usb_total=${#usb_devices[@]}

        for u in "${usb_devices[@]}"; do
            if [ -d "$u" ]; then
                usb_count=$((usb_count + 1))
                bus=$(cat "${u}/busnum")

                lsusb_info=$(lsusb -s "$bus:" | awk '
                    {
                        gsub(/:/, "", $4);
                        printf "%s|%s %s %s %s|", $6, $1, $2, $3, $4;
                        for (i = 7; i <= NF; i++) { printf "%s ", $i }
                        printf "\n"
                    }' | awk -F"|" '{printf "[%s]  %-40s %s\n", $1, $2, $3}')

                # Determine tree formatting for USB
                if [ "$usb_count" -eq "$usb_total" ]; then
                    printf "%s└── USB: %s\n" "$prefix" "$lsusb_info"
                else
                    printf "%s├── USB: %s\n" "$prefix" "$lsusb_info"
                fi
            fi
        done
    done
done
